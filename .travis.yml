language: java
jdk: oraclejdk8

cache:
  directories:
  - "$HOME/.m2/repository"
  
services:
- docker

before_install:
- openssl aes-256-cbc -K $encrypted_cde168f57e0b_key -iv $encrypted_cde168f57e0b_iv
-in travis_deploy_rsa.enc -out /tmp/travis_deploy_rsa -d
- chmod 600 /tmp/travis_deploy_rsa
- eval "$(ssh-agent -s)"
- ssh-add /tmp/travis_deploy_rsa
- echo -e "Host $SERVER_IP_ADDRESS\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
- sudo service mysql stop
- docker pull takimatraining/devops-training-db
- docker run -d -p 127.0.0.1:3306:3306 takimatraining/devops-training-db

script:
- |
mvn clean install sonar:sonar \
  -Dsonar.projectKey=Nostiga_sample-application-students \
  -Dsonar.organization=nostiga-github \
  -Dsonar.host.url=https://sonarcloud.io \
  -Dsonar.login=$SONAR_TOKEN #b4b671e94e8b7f85a2ff1107a95b0e97d8da5274
    
notifications:
  email:
    on_failure: always
    
after_success:
- docker login -u $DOCKER_USER -p $DOCKER_PASS
- export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH;
fi`
- export IMAGE_NAME=Nostiga/sample-application
- docker build -t $IMAGE_NAME:$TRAVIS_COMMIT .
- docker tag $IMAGE_NAME:$TRAVIS_COMMIT $IMAGE_NAME:$TAG
- docker push $IMAGE_NAME:$TAG

# Deploy updated container over ssh
deploy:
  provider: script
  script: ssh -i /tmp/travis_deploy_rsa $DEPLOY_USER@$SERVER_IP_ADDRESS "sudo docker pull $IMAGE_NAME:$TAG && sudo docker rm -f app || true && sudo docker run -d --network net -p 80:8080 --name app $IMAGE_NAME:$TAG"
  on:
    branch: master

env:
  global:
  - secure: uLGTWlG4blbLnFvhd7EO1QvUQuUfIf/HBH6WatLXAVybKYkVXXnoXqkZeh8UY4y1cDyDzNis588WSZEAQNEo1wCLig0+ZzO2QQszuET9hAEg0Z8P/GYDzV4c0jHASDFDnSTpjaej1GwB7BkIv1kmXtjKonZp8nygSI6Cm2fn0GwuYeF91fZGhzCwpnLyMrijq/IaikrqGmkVg867UqSpdjOoCH9dXu7t2/6SQkRCkGbHN5jC00KgFU8qQi5VTehGi0VDxjz3C+utsnSVb5CMaTJm+26/uCEeNDXZRuGe0y+HBsQqMsdPlbrGl/YIeKQ+ppa3Q9Ak7TRLPFdJoLDTJrLDNpD89Qnw2ryG+txNxmKl1vCc62NEp0Di1Tw/bNzNuckz/kGZ8NS2lz4W56gPREhxZwc7V3MPK7ymAE1VGX2k68yV3djLaWsW2km9rEIWgJPRp009sVmsMVFfz47KfGu350YPaH/AB04dmJGb+EtY6F+GtKYEA7HXEjU5vrnNGuoxk9Pue+LhoFSflITRNXUCjRuswPXFSsYiQ/f0e83Sii7DdMQcAx0k+LGy9GWm/m5FXkL6GI9kI7t8881swFGc9F6OY8VXAVoZBMBn1CLkpXcTNnQVicCTKBiRgTrQ0L6cdMzWyJnHO5VvDcL0dfmeJ0VliyEpv6Di4l8aZ7U=
  - secure: pT/1RzX/odDZNiSWtkMPHHQHRAH5I8B7q2n5UQtX11d2Mwg3BMvRnK1+qBPE2/JTtD7Coe4ioVUJVScHR2SZNGjliQyXYNBTy/uzHpOBFigm9LHGuCYxkPUUeW52kXD7DIzZz6GAL4m7UgSnG64C6fWfrKtj2maR2tfrB3VhkpQl8MxZ6v2GfyNHr0qS8R4MUx1TS+06eHQNlvHCz8hehbmbCk94LCzc2PHhkEYQrCDId0kPoKr/FNxBXs6brict99ooha6YgcW6SUDJ1Z4woyQtLevoreRPiNqWiYtmMgVV7YKgAzlB4NtlC0vlOclcbKzJ1J/HfcvZJD0mt29Ydn2j04g6eY5ob2aD6YIoJTLwSs/QXvJ8H83vzH5Tv+d/c2mKlxS3+nMozaR2sxoBBwy2FJ3qDUklJ2Of6oG4yEyG7Yi0u446xbzuLMdALtFV1e9vTypxCV6L2/J/r6mA59BcEMT/79Rqz4q1KXwscllXbKJHy1PVNJZ/J98IRKHVDjQ9GVj3Qkg7lEWi9Oz0eWVeXWZZ+vYK0ql75v4Tt8bVTBy27s0ZMbPrqxjqwdSScqgfgbR4RBxQP/kGSqjY2tA698EAf7bPQFXUZPKciAtWUxcNEq6qzJWCM6aw82HEPAq5RMVG34fVb5+XQnVMtM0ikD6Rw6K+UudntABiLYQ=
  - secure: FksiMVX5u4OcFhhQ0VGAEX2dIvYapxdhSCJl3mhCsqrxs+Di16VG33vMGzYcW3wm7tT30oD0IL0g1FY3cFdm13AyoLIge4d2GueZs3LMmPjuCxbIB9Yblb3T329zi0OIuaxs88fz1MqKOk3Xy83bxmGZTJeM2ojzcQ/JuS+DIDAAlXSBQTPV3Z6p5r04hkJQW1AHL3MhI9+VWzCKGYrs63JTgWEX6qLKugIiV+dtab+iW+jmibZreY+IaY+VWAadg6lxYQ8Uxsk9GOZDda4lUMcHpcvPWLSO4e5bVlL5Ke5S78F+pWpJRRu/kRIyZfI028VlC673WCDSSU0NlNnUoL4ZLHpDCnlZlOAzkhFvcV+yTK1PHLCkxp41pmEOJHgdU63jE8vKNNMJpx/QZa7uIaTq4P2jGi/rpwEimW67AB/lW2z0SQ7WkfdA0hg7cf0i/q/wxNruMCF0KupY+LfmZ9eGU0C/DIGTcMqNXuv/7IfEnHaKKpfO9YaSbjWYoW+WQ8DUiXjpVKA1UJeNVuqUNC7kqxxUVWJmklMObo/bfy8HlOySwHDf9ksWe7P1XZbjPPMIUoKSv/tG6NKbODuGvsqAxuNnmbkg/lh277I1mXj3IihuEnmV+/pPaxpm+CZlI3T7z+3eRoS13Qsy8AbjnE3PS5saRyw7A1cCWCcUcwE=
  - secure: KGwGBN21gsH1NoKOJ+8NxjAxZ/YJeVhdZ83eLZrhGnIwUzWTyb4bg7ZHFeWXF82Srz1XacIsI8lI8d9wSdjLPQowdg+XUlDcF+6hD8zqg6d+YrbXEl/u2rlzRjCyRyxiUmuiYMMI3z0yWZVO7MlurdVw9/cFOHo8XJ3UVJ/SpItwYVc/BOJ8rMdJtcM+gbWtFnDRdxnqzNMXwzMgTCw7m1SgnMKAibAnBSDU5fOwATU6oaEAXcDW3Fd87jpJweVaB7lMjjnaVBzmph0vgKhvMXwWvL8pgXktK/LPNZSzyHfBHOoXGpEXKWWinPls/TEJgwDEN7NrnowIrqmkTwcPAWPxG2zMetTCu3baaAppmX5HIkRbuVCDkihy1cT/856EYm2VEQoolETBfbPgFGVuCWNTpGkAnM1FbsGtZH9AqEqlFZ5OSgFn/MMTGDN4h/a/Qsp7aBOSoy0HxqZQlt92Ti13JV1tqxtW1H5U8j90kRuIHzeR9UP7PLhHjdcjFRFweNQxIAABj9nf6xuXIqTOpcVeytJeXH+dT1f7x1KhODqfa2txd2gWGenct5dH0j/mT5m1gjLstIdXs2Nlwmnpj10nq/UCj6NQLf1ADv+zmzeR5AYeNq4FslaVExSYxocbk7wdqe1RvcD5DE8PfkCl0oy6/W44zRSq32hTCvcA2KQ=
  - secure: cCY2aRfiKtup6XnU9fJ8+qA/93SuGjtfRO8pvc6WfJMNdrnqWKypIsB6vShgJdANmcOxihivWGnVy7Iws135jnUPI/qZkZBPMDyfdJC5iSfFtkQIqGiMStTPJAWi507ijHpmw9a6LicTnnhlGh/0vuA7zQvSP0r0wA3STydXB0tZBEfxOozmfdjSMgD31Upi447Bfy4o6J9zEEloxVRKh9KKXOknbiY8HGEwsgB0PyXlB6Sd1l80v10VNUjw/o9O+Y0jHVeo3618OSYFb/4ogqAusuj2T0Bv+XFfomGCuG9/nB1u+4cX+3s7ZRdt+nkyHEfaPCJxkUvH05hWH6+WsOdUOlDIyXjQ38CW2LRem0vt6Jh2ml7um4QkJDV9Dh8+VK9L76Tav9Wss4w9WIfzqs0UusPoFj0XaKHU/4/NphPeBfK51XVqEbuZxVsUZISDxDa0qLCbVUVx85mulPYw7ufCgU4oru57ZPMc/eswIE8iRgSEVjmw5lsuF/F+PazoURJsDJro5VmnBjIEnZZUaxG8rQzz/TqW/eIPTeMJARdm6p1bdTEyxRJZ40zq0OHubld/kNGlvbTrb263Rzmab+zI4r1qWwDJtNqzHcTLKPNvTrZowtQWuEkydEm3Er7BPDnutCSAlVnsrUOTpEcQZpgK757AWzPdBYib4OhMPKY=
