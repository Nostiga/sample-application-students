language: java
jdk: oraclejdk8

cache:
  directories:
    - "$HOME/.m2/repository"
  
services:
  - docker

before_install:
  - openssl aes-256-cbc -K $encrypted_cde168f57e0b_key -iv $encrypted_cde168f57e0b_iv
    -in travis_deploy_rsa.enc -out /tmp/travis_deploy_rsa -d
  - chmod 600 /tmp/travis_deploy_rsa
  - eval "$(ssh-agent -s)"
  - ssh-add /tmp/travis_deploy_rsa
  - echo -e "Host $SERVER_IP_ADDRESS\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
  - sudo service mysql stop
  - docker pull takimatraining/devops-training-db
  - docker run -d -p 127.0.0.1:3306:3306 takimatraining/devops-training-db

script:
  - |
    mvn clean install sonar:sonar \
      -Dsonar.projectKey=Nostiga_sample-application-students \
      -Dsonar.organization=nostiga-github \
      -Dsonar.host.url=https://sonarcloud.io \
      -Dsonar.login=$SONAR_TOKEN #b4b671e94e8b7f85a2ff1107a95b0e97d8da5274
    
notifications:
  email:
    on_failure: always
    
after_success:
  - docker login -u $DOCKER_USER -p $DOCKER_PASS
  - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH; fi`
  - export IMAGE_NAME=Nostiga/sample-application
  - docker build -t $IMAGE_NAME:$TRAVIS_COMMIT .
  - docker tag $IMAGE_NAME:$TRAVIS_COMMIT $IMAGE_NAME:$TAG
  - docker push $IMAGE_NAME:$TAG

# Deploy updated container over ssh
deploy:
  provider: script
  script: ssh -i /tmp/travis_deploy_rsa $DEPLOY_USER@$SERVER_IP_ADDRESS "sudo docker pull $IMAGE_NAME:$TAG && sudo docker rm -f app || true && sudo docker run -d --network net -p 80:8080 --name app $IMAGE_NAME:$TAG"
  on:
    branch: master

env:
  global:
    - secure: "uLGTWlG4blbLnFvhd7EO1QvUQuUfIf/HBH6WatLXAVybKYkVXXnoXqkZeh8UY4y1cDyDzNis588WSZEAQNEo1wCLig0+ZzO2QQszuET9hAEg0Z8P/GYDzV4c0jHASDFDnSTpjaej1GwB7BkIv1kmXtjKonZp8nygSI6Cm2fn0GwuYeF91fZGhzCwpnLyMrijq/IaikrqGmkVg867UqSpdjOoCH9dXu7t2/6SQkRCkGbHN5jC00KgFU8qQi5VTehGi0VDxjz3C+utsnSVb5CMaTJm+26/uCEeNDXZRuGe0y+HBsQqMsdPlbrGl/YIeKQ+ppa3Q9Ak7TRLPFdJoLDTJrLDNpD89Qnw2ryG+txNxmKl1vCc62NEp0Di1Tw/bNzNuckz/kGZ8NS2lz4W56gPREhxZwc7V3MPK7ymAE1VGX2k68yV3djLaWsW2km9rEIWgJPRp009sVmsMVFfz47KfGu350YPaH/AB04dmJGb+EtY6F+GtKYEA7HXEjU5vrnNGuoxk9Pue+LhoFSflITRNXUCjRuswPXFSsYiQ/f0e83Sii7DdMQcAx0k+LGy9GWm/m5FXkL6GI9kI7t8881swFGc9F6OY8VXAVoZBMBn1CLkpXcTNnQVicCTKBiRgTrQ0L6cdMzWyJnHO5VvDcL0dfmeJ0VliyEpv6Di4l8aZ7U=" #SONAR_TOKEN
    
    - secure: "amrY+CCItWjZTYMd0Hy60l/L/J1oPBUAqeC1N8bOJNIUwCuEmI96VA7oQzm/o3fC7xcS1iWMp+/hZTK9p4ef+avUS67Yw49KxKHRWIFjGI4K9/MYYyMriBH+4Q8QAhjDW+MZlzommmG9n6kq3YJYQ8LnGUXzezQDnE0xiq7GRrH7Z3deYDD4VKVQ05QrF38Im83wChFBc+qQE4T30xyoXP7NHiW9ltTXO/4Iar8XQa4ES0g1+/iMpuV+xo35rChVSMrEvVlbp+5IU/lUDEnMjCxcZMjPDhR00uMw6dKJkq6ufOwKI0t6tKQXpKMYP+ZaabQr6/CpYo/BY7ek9m0LJYyA6xiwxF54SMi0ezwrvjCtkkNxH/tQKrxLJikxI9+I4OhQQDPU/2DfEUmBg4FuOkCYvtiBZIJGI5bwagmcX2KqfKLwISu6VuK/kQhj+RB7ovQQwUmZoxgqx7mcXwE1hywRv6hfz76RFEmuLR24xH58B55+5GiWG+5VjEJddHgyCbsFXIWB/vM2hB2K9DneUJW9dxehAix685WBVmUe4rS8jLs+q+btRHut/Bo68mhboWXTQOcafHMGa6w0hX8NK9byLEN3XG9/BvBfwExP+mSSx3mIZ85LIGwiw9Xp2ilFR6ENJhrNuQJks6CtxFY0h195bpWabbu7NF68IAknRj0=" #DOCKER_USER
    
    - secure: "S7GVihv1AYVZwaH8m9lI4S+cgVy3xVCVrjic7C5uyR93CbA9/gMrBsK1z3+5xKYfeFwdl6BPnR5xJNl+usF0oaqh+LIRQVlTiOi5nc4tJvyQhsdBnwZkYyxziZY2jwNkoKvkhYQT4q7SpX2q4/a2KiYnItkQcGmSziugoOZgeRwmWOvTLL5W6h8Y+RVdaGY/ThgkowwpRUz/6uS+LKH7T2CNWfdPmSEruqv8iRHI0T3aXWR1EeWQ2hbqZ/Tl2rvU+WOdJNLKxC1LQ1yX9jBz8D8+zilw8KYHY27xIxqqRYrjuwju+W+gj4fm5p7xn+73Q4ci8Na3B9S7F2nCnaD2Ge9jk+BBTdwBgvZt8FNf22OKeub2eGSk70BasW2RA9QcualokyIrciyVv5glWPuonJbsZOcGzN0FdtZd+hHj/46199NZFBfPiSkVyLeIeJMHBzNmU4zfFPH2sSRolNPw6Rt6sdbWsl9wRuhDTxj8AWMn5V5N019Fi5ziKzESD5v+04AHgpiQeAu06nWXItfNS9RSrrB6hYsi42mjeLS7+eqN6sB7SjvQ4K02hjDrmvEvfEP99qTELWITBTEpvgNBTg7wMn6wY9mJNLx5UUZq1Dwju9eJG8SQS7iFRPSksmQDKmsM0sD8CU0xVMKqEnr65HYgDt3Z1Zz61EQn497yyxY=" #DOCKER_PASS

    - secure: KGwGBN21gsH1NoKOJ+8NxjAxZ/YJeVhdZ83eLZrhGnIwUzWTyb4bg7ZHFeWXF82Srz1XacIsI8lI8d9wSdjLPQowdg+XUlDcF+6hD8zqg6d+YrbXEl/u2rlzRjCyRyxiUmuiYMMI3z0yWZVO7MlurdVw9/cFOHo8XJ3UVJ/SpItwYVc/BOJ8rMdJtcM+gbWtFnDRdxnqzNMXwzMgTCw7m1SgnMKAibAnBSDU5fOwATU6oaEAXcDW3Fd87jpJweVaB7lMjjnaVBzmph0vgKhvMXwWvL8pgXktK/LPNZSzyHfBHOoXGpEXKWWinPls/TEJgwDEN7NrnowIrqmkTwcPAWPxG2zMetTCu3baaAppmX5HIkRbuVCDkihy1cT/856EYm2VEQoolETBfbPgFGVuCWNTpGkAnM1FbsGtZH9AqEqlFZ5OSgFn/MMTGDN4h/a/Qsp7aBOSoy0HxqZQlt92Ti13JV1tqxtW1H5U8j90kRuIHzeR9UP7PLhHjdcjFRFweNQxIAABj9nf6xuXIqTOpcVeytJeXH+dT1f7x1KhODqfa2txd2gWGenct5dH0j/mT5m1gjLstIdXs2Nlwmnpj10nq/UCj6NQLf1ADv+zmzeR5AYeNq4FslaVExSYxocbk7wdqe1RvcD5DE8PfkCl0oy6/W44zRSq32hTCvcA2KQ=
    - secure: cCY2aRfiKtup6XnU9fJ8+qA/93SuGjtfRO8pvc6WfJMNdrnqWKypIsB6vShgJdANmcOxihivWGnVy7Iws135jnUPI/qZkZBPMDyfdJC5iSfFtkQIqGiMStTPJAWi507ijHpmw9a6LicTnnhlGh/0vuA7zQvSP0r0wA3STydXB0tZBEfxOozmfdjSMgD31Upi447Bfy4o6J9zEEloxVRKh9KKXOknbiY8HGEwsgB0PyXlB6Sd1l80v10VNUjw/o9O+Y0jHVeo3618OSYFb/4ogqAusuj2T0Bv+XFfomGCuG9/nB1u+4cX+3s7ZRdt+nkyHEfaPCJxkUvH05hWH6+WsOdUOlDIyXjQ38CW2LRem0vt6Jh2ml7um4QkJDV9Dh8+VK9L76Tav9Wss4w9WIfzqs0UusPoFj0XaKHU/4/NphPeBfK51XVqEbuZxVsUZISDxDa0qLCbVUVx85mulPYw7ufCgU4oru57ZPMc/eswIE8iRgSEVjmw5lsuF/F+PazoURJsDJro5VmnBjIEnZZUaxG8rQzz/TqW/eIPTeMJARdm6p1bdTEyxRJZ40zq0OHubld/kNGlvbTrb263Rzmab+zI4r1qWwDJtNqzHcTLKPNvTrZowtQWuEkydEm3Er7BPDnutCSAlVnsrUOTpEcQZpgK757AWzPdBYib4OhMPKY=
